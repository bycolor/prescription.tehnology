<!DOCTYPE html>
<html>
	<head>
		<title>Prescription Technology</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="css/reset.css" media="screen" />
		<link rel="stylesheet" type="text/css" href="css/responsive.gs.24col.css" media="screen" />
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />
		<link rel="stylesheet" type="text/css" href="css/styles.css" media="screen" />
		<script type="text/javascript" src="cordova.js"></script>
		<script type="text/javascript" src="js/respond.min.js"></script>
		<script type="text/javascript" src="js/jquery-1.10.2.min.js"></script>
		<script type="text/javascript" src="js/custom.jquery.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Open+Sans:400,300,300italic,400italic,600,600italic,700,800,700italic" rel="stylesheet" type="text/css" />
	</head>
	<body id="conectare">
		<!-- Preloader -->
		<div id="page-preloader">
			<img class="preloader" src="img/loading.gif" alt=""/>
		</div>
		
		<div class="container wrap">
			<div class="row gutters">
				<div class="col span_24">
					<a href="/" id="logo" title="Prescription Technology - Order Form" /><img src="img/logo_PT_big.png" alt="" /></a>
					<!--<a href="/" id="nav-toggle" title="Prescription Technology - Order Form Menu" />Menu</a>-->
				</div>
			</div>
		</div>

		<div class="container wrap">
			<h1>Order Form</h1>
			<form id="loginform" name="loginform" action="https://prescription.technology/___include/ajax/ajax.app.regcust.asp" method="get" class="row gutters">
				<input type="text" id="loginemail" name="loginemail" value="" placeholder="Enter your username" />
				<input type="password" id="loginpassword" name="loginpassword" value="" placeholder="Enter your username" />
				<button type="submit" class="btn btn-big has-icon" id="login-submit"><div class="btn-text">Sign in</div><div class="btn-icon"><i class="fa fa-angle-double-right"></i></div></button>
				<div id="response-holder"></div>
				<div id="response-holder2"></div>
				<div id="response-holder3"></div>
				<div id="response-holder-nodata"></div>
				<div id="response-holder-notlogged" style="display:none;">You are not logged in</div>
			</form>
		</div>
		<script type="text/javascript">
			var oLocalStorage = new classLocalStorage();
			function PowerUp() {
				var oLocalStorage = new classLocalStorage();
				var $loginForm = $('#loginform');
				var $loginSubmit = $('#login-submit');
				var $responseHolder = $('#response-holder');
				var $responseHolder2 = $('#response-holder2');
				var $responseHolderNoData = $('#response-holder-nodata');
				var $responseHolderNotLogged = $('#response-holder-notlogged');
				var $pagePreloader = $('#page-preloader');

				function Login() {
					$pagePreloader.show();
					var sidname = window.localStorage.getItem('sidname');
					var sid = window.localStorage.getItem('sid');
					if (typeof sidname != 'undefined' && sidname !== null) { oLocalStorage.sidname = sidname; };
					if (typeof sid != 'undefined' && sid !== null) { oLocalStorage.sid = sid; };
					var jqxhr = $.ajax({
						type: $loginForm.prop('method'),
						url: $loginForm.prop('action'),
						//data: params
						dataType: 'html',
						beforeSend: function (request) {
							if (typeof oLocalStorage.sidname != 'undefined' && oLocalStorage.sidname !== null && typeof oLocalStorage.sid != 'undefined' && oLocalStorage.sid !== null) {
								alert('Conectare - Setting cookie ' + oLocalStorage.sidname + ' to ' + oLocalStorage.sid);
								//request.setRequestHeader("Cookie", sid);
							}
						},
						data: $loginForm.serialize()
					}).fail(function(response) {
						// Failure
						var json = $.parseJSON(response);
						var status = json.status;
						var message = json.message;

						var messages = ''
										+ '<p class="alert error">status: ' + status + '</p>'
										+ '<p class="alert error">message: ' + message + '</p>'
										;
						$responseHolder.append(messages).show();
						oLocalStorage.ClearSession();
					}).done(function(response) {
						// Success
						try {
							messages = '';
							//console.log('conectare.html - response: ' + response);
							var json = $.parseJSON(response);
							//console.log('json: ');
							//console.log(json);
							var status = json.status;
							var message = json.message;
							//console.log('status: ' + status);
							if (status) {
								var user = json.user;
								var order = json.order;
								oLocalStorage.SetLoggedData(json);
								console.log('json: ' + json);
								//alert('conectare.html 1 - login after SetLoggedData - oLocalStorage.logged: ' + oLocalStorage.logged);
								if (oLocalStorage.logged == 1) {
									//alert('logged is true, redirect to index.html');
									window.location.href = 'index.html';
								} else {
									//alert('logged is false, no redirect');
									// Error - Reading local storage data
									messages += '<p class="alert error">Could not read local storage data</p><p class="alert error">' + message + '</p>';
								}
								//$responseHolder.hide().html(messages).fadeIn('fast');
							} else {
								// Error - Credentials error
								$responseHolder.hide().html('<p class="alert error">' + message + '</p>').fadeIn('fast');
								oLocalStorage.ClearSession();
							}
						} catch (err) {
							// Error - Misc
							messages = '<p class="alert error">Call succceeded, but parsing got an error: ' + err.message + '.</p>';
							$responseHolder.hide().html(messages).fadeIn('fast');
							$responseHolder2.hide().html('<p class="alert error">response: ' + response + '</p>').fadeIn('fast');
						}
						return false;
					}).always(function() {
						//alert( "complete" );
						$pagePreloader.fadeOut();
					});
					return false;
				};
				
				$loginForm.on('touchstart click', '#login-submit', function(e){
					e.preventDefault();
					Login();
				}).on('kewdown', '#loginemail, #loginpass', function(e){
					var code = e.keyCode || e.which;
					if(code == 13) { //Enter keycode
						e.preventDefault();
						Login();
					}
				});
				
				/* Sursa: http://ko-lwin.blogspot.ro/2010/12/how-to-secure-classic-asp-session-id.html */
				/*
				function getSessionKey() {
					var c_name = "ASPSESSIONID";
					if (document.cookie.length > 0) {
						c_start = document.cookie.indexOf(c_name);
						if (c_start!=-1) {
							c_end=document.cookie.indexOf("=",c_start);
							if (c_end==-1) c_end=document.cookie.length;
							return unescape(document.cookie.substring(c_start,c_end));
						}
					}
					return "";
				}

				function submit() {
					document.loginform.sessionid.value = getSessionKey();
					//alert("document.loginform.sessionid.value: " + document.loginform.sessionid.value);
				}
				submit();
				*/
			};

			$(function() {
				//alert('conectare.html 1 - oLocalStorage.logged: ' + oLocalStorage.logged);
				//alert('conectare.html 1 - !oLocalStorage.logged: ' + (!oLocalStorage.logged));
				//alert('conectare.html 1 - !oLocalStorage.logged: ' +  (oLocalStorage.logged == 1));
				oLocalStorage.IsLogged();
				if (oLocalStorage.logged == 1) {
					window.location.href = 'index.html';
				} else {
					document.addEventListener("deviceready", PowerUp, true);
					
					/* Only for in-browser (not in Android) testing */
					PowerUp();
				}
			});
        </script>
	</body>
</html>